name: Agents CI

on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  checkout:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.checkout.outputs.sha }}
    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

  lint-frontend:
    needs: checkout
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install YAML & JSON tooling
        run: python -m pip install pyyaml jsonschema markdown
      - name: Validate frontmatter
        run: python scripts/validate_frontmatter.py || (echo "Frontmatter validation failed" && exit 1)

  md-reformatter-dryrun:
    needs: lint-frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install requirements
        run: python -m pip install pyyaml markdown jsonschema
      - name: Run deterministic reformatter
        run: |
          python scripts/run_reformatter.py || (echo "Reformatter failed" && exit 1)
      - name: Validate Transformation Manifest (if produced)
        run: |
          if [ -f transformation_manifest.json ]; then python scripts/validate_json.py schemas/transformation_manifest.schema.json transformation_manifest.json; else echo "No changes -> no manifest"; fi

  refactor-plan-check:
    needs: [lint-frontend, md-reformatter-dryrun]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate refactor plan (if Python changes)
        run: |
          python scripts/validate_refactor_plan.py || (echo "Refactor plan validation failed" && exit 1)

  unit-tests:
    needs: refactor-plan-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install project dependencies (requirements)
        run: |
          python -m pip install --upgrade pip
          pip install -r req_vm.txt
          pip install coverage
      - name: Run unit tests (exclude integration)
        run: |
          mkdir -p reports
          pytest -m "not integration" --junitxml=reports/unit-results.xml || (echo "Unit tests failed" && exit 1)
      - name: Upload unit tests report
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-report
          path: reports/unit-results.xml

  coverage:
    needs: unit-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install project dependencies (requirements)
        run: |
          python -m pip install --upgrade pip
          pip install -r req_vm.txt
          pip install coverage
      - name: Run coverage
        run: |
          coverage run -m pytest -m "not integration"
          coverage xml -o coverage.xml
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage.xml
